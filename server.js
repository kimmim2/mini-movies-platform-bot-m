require('dotenv').config();
const express = require('express');
const cors = require('cors');
const TelegramBot = require('node-telegram-bot-api');
const path = require('path');
const fetch = require('node-fetch'); // <-- ржирждрзБржи рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржпрзБржХрзНржд

const app = express();
const PORT = process.env.PORT || 5000;

// Enable CORS for all origins
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Video storage (url field is replaced by telegram_file_id)
// NOTE: For live streaming to work, you MUST use the /video/:id route
let videos = [
    {
        id: 1,
        title: "Private Video Demo 1",
        // ржПржЦрж╛ржирзЗ Telegram File ID ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ (Dummy ID)
        telegram_file_id: "BAACAgIAAxkDAAICrWZc0_9e5n4E-4pQG9QYx0D0a_eD0", 
        size: 50000000, // ржлрж╛ржЗрж▓рзЗрж░ ржЖржХрж╛рж░ ржмрж╛ржЗржЯрзЗ (рж╕рзНржЯрзНрж░рж┐ржорж┐ржВ ржПрж░ ржЬржирзНржп ржЬрж░рзБрж░рж┐)
        thumbnail: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/BigBuckBunny.jpg",
        description: "This is a private video streamed through the bot proxy.",
        views: 150,
        category: "movie",
        addedAt: new Date().toISOString()
    },
    {
        id: 2,
        title: "Private Video Demo 2",
        telegram_file_id: "BAACAgIAAxkDAAICrWZc0_9e5n4E-4pQG9QYx0D0a_eD1", 
        size: 25000000, 
        thumbnail: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ElephantsDream.jpg",
        description: "A short computer-animated film produced by the Blender Institute.",
        views: 89,
        category: "drama",
        addedAt: new Date().toISOString()
    }
    // ржЖржкржирж┐ ржЖржкржирж╛рж░ рж╕ржм ржнрж┐ржбрж┐ржУрж░ File ID ржПржмржВ Size ржПржЦрж╛ржирзЗ ржпрзБржХрзНржд ржХрж░ржмрзЗржи
];

// Telegram Bot Setup - Only initialize if token is provided
let bot = null;
const adminChatIds = process.env.ADMIN_CHAT_IDS ? process.env.ADMIN_CHAT_IDS.split(',').map(id => id.trim()) : [];
const PRIVATE_CHANNEL_ID = process.env.PRIVATE_CHANNEL_ID; // ржЖржкржирж╛рж░ ржЪрзНржпрж╛ржирзЗрж▓рзЗрж░ ржЖржЗржбрж┐

if (process.env.TELEGRAM_BOT_TOKEN) {
    bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: true });
} else {
    console.log('тЪая╕П Telegram Bot disabled: TELEGRAM_BOT_TOKEN not provided');
}

// Serve main page
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ======================================================================
// ржирждрзБржи API: Private Channel Video Streaming Proxy
// ======================================================================

app.get('/video/:videoId', async (req, res) => {
    const videoId = parseInt(req.params.videoId);
    const videoData = videos.find(v => v.id === videoId);

    if (!videoData || !videoData.telegram_file_id || !bot) {
        return res.status(404).send('Video not found or Bot is not initialized.');
    }

    // рзз. Telegram API ржерзЗржХрзЗ ржлрж╛ржЗрж▓ рж▓рж┐ржЩрзНржХ ржирж┐ржи
    let telegramFileUrl;
    try {
        const fileLinkResponse = await bot.getFileLink(videoData.telegram_file_id);
        telegramFileUrl = fileLinkResponse.href;
    } catch (error) {
        console.error('Error getting Telegram File Link:', error.message);
        return res.status(500).send('Could not get file link from Telegram. Check if bot is admin in channel.');
    }

    // рзи. Range Header рждрзИрж░рж┐ ржХрж░рзЗ Proxy Request ржкрж╛ржарж╛ржи
    try {
        const headers = {};
        if (req.headers.range) {
            headers['Range'] = req.headers.range;
        }

        const fileResponse = await fetch(telegramFileUrl, { headers });

        if (!fileResponse.ok) {
            console.error(`Error fetching video from Telegram: ${fileResponse.statusText}`);
            return res.status(500).send('Could not fetch video content from Telegram.');
        }

        // рзй. рж╕рзНржЯрзНрж░рж┐ржорж┐ржВ Header рж╕рзЗржЯржЖржк
        const contentRange = fileResponse.headers.get('Content-Range');
        const contentLength = fileResponse.headers.get('Content-Length');
        const acceptRanges = fileResponse.headers.get('Accept-Ranges') || 'bytes';
        const statusCode = fileResponse.status;
        
        // рж╕ржорж╕рзНржд ржкрзНрж░рзЯрзЛржЬржирзАрзЯ header ржХрзНрж▓рж╛рзЯрзЗржирзНржЯрзЗрж░ ржХрж╛ржЫрзЗ ржлрзЗрж░ржд ржкрж╛ржарж╛ржи
        res.writeHead(statusCode, {
            'Content-Type': 'video/mp4',
            'Content-Length': contentLength,
            'Accept-Ranges': acceptRanges,
            ...(contentRange && {'Content-Range': contentRange})
        });

        // рзк. Stream рж╢рзБрж░рзБ ржХрж░рзБржи
        fileResponse.body.pipe(res);

    } catch (error) {
        console.error('Video Streaming Proxy Error:', error);
        res.status(500).send('Internal server error during streaming proxy.');
    }
});

// ======================================================================
// API endpoints
// ======================================================================

// /api/videos рж░рзБржЯ ржЖржкржбрзЗржЯ: ржПржЯрж┐ ржнрж┐ржбрж┐ржУрж░ ржЖрж╕рж▓ URL ржПрж░ ржмржжрж▓рзЗ ржирждрзБржи ржкрзНрж░ржХрзНрж╕рж┐ рж▓рж┐ржЩрзНржХ ржкрж╛ржарж╛ржмрзЗ
app.get('/api/videos', (req, res) => {
    const updatedVideos = videos.map(v => ({
        ...v,
        // Frontend ржП ржкрзНрж▓рзЗ ржХрж░рж╛рж░ ржЬржирзНржп ржирждрзБржи ржкрзНрж░ржХрзНрж╕рж┐ URL: /video/:id
        url: `${req.protocol}://${req.get('host')}/video/${v.id}`, 
        telegram_file_id: undefined, // ржирж┐рж░рж╛ржкрждрзНрждрж╛рж░ ржЬржирзНржп ржлрж╛ржЗрж▓ ржЖржЗржбрж┐ рж▓рзБржХрж┐рзЯрзЗ рж░рж╛ржЦрж╛
        size: undefined
    }));
    res.json({ videos: updatedVideos });
});


// /api/videos (POST) рж░рзБржЯ ржЖржкржбрзЗржЯ: ржПржЦржи URL ржПрж░ ржмржжрж▓рзЗ File ID ржПржмржВ Size ржирзЗржмрзЗ
app.post('/api/videos', (req, res) => {
    const { title, telegram_file_id, thumbnail, description, size } = req.body;
    const video = {
        id: Date.now(),
        title,
        telegram_file_id, // File ID рж╕рзЗржн ржХрж░рж╛ рж╣рж▓рзЛ
        size: size || 0, // Size рж╕рзЗржн ржХрж░рж╛ рж╣рж▓рзЛ
        thumbnail: thumbnail || '/assets/default-thumb.jpg',
        description: description || '',
        views: 0,
        category: 'movie', // Default
        addedAt: new Date().toISOString()
    };
    videos.push(video);
    res.json({ success: true, video });
});


app.delete('/api/videos/:id', (req, res) => {
    const videoId = parseInt(req.params.id);
    videos = videos.filter(v => v.id !== videoId);
    res.json({ success: true });
});

app.post('/api/videos/:id/view', (req, res) => {
    const videoId = parseInt(req.params.id);
    const video = videos.find(v => v.id === videoId);
    if (video) {
        video.views = (video.views || 0) + 1;
        res.json({ success: true, views: video.views });
    } else {
        res.status(404).json({ success: false, error: 'Video not found' });
    }
});

// ======================================================================
// Telegram Bot Commands (only if bot is initialized)
// ======================================================================
if (bot) {
    // Admin only commands
    function isAdmin(chatId) {
        return adminChatIds.includes(chatId.toString());
    }

    bot.onText(/\/start/, (msg) => {
        // ... (existing /start logic) ...
        const chatId = msg.chat.id;
        const welcomeMsg = `ЁЯОм Mini Movies Bot ржП рж╕рзНржмрж╛ржЧрждржо!

Admin Commands (рж╢рзБржзрзБ Admin ржжрзЗрж░ ржЬржирзНржп):
/addvideo - ржирждрзБржи ржнрж┐ржбрж┐ржУ ржпрзЛржЧ ржХрж░рзБржи
/removevideo - ржнрж┐ржбрж┐ржУ ржорзБржЫрзБржи
/listvideo - рж╕ржм ржнрж┐ржбрж┐ржУ ржжрзЗржЦрзБржи
/stats - Statistics ржжрзЗржЦрзБржи

рж╕рж╛ржзрж╛рж░ржг Commands:
/help - рж╕рж╛рж╣рж╛ржпрзНржп
/website - Website рж▓рж┐ржВржХ`;
        
        bot.sendMessage(chatId, welcomeMsg);
    });

    // ... (existing /help, /website logic) ...
    bot.onText(/\/help/, (msg) => {
        const chatId = msg.chat.id;
        const helpMsg = `ЁЯЖШ рж╕рж╛рж╣рж╛ржпрзНржп:

ржПржЗ ржмржЯ ржжрж┐ржпрж╝рзЗ ржЖржкржирж┐ Mini Movies Platform ржорзНржпрж╛ржирзЗржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред

Admin рж░рж╛ ржирждрзБржи ржнрж┐ржбрж┐ржУ add ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи, ржнрж┐ржбрж┐ржУ remove ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржПржмржВ statistics ржжрзЗржЦрждрзЗ ржкрж╛рж░ржмрзЗржиред

Website: ${process.env.REPLIT_DOMAINS || 'http://localhost:5000'}`;
        
        bot.sendMessage(chatId, helpMsg);
    });

    bot.onText(/\/website/, (msg) => {
        const chatId = msg.chat.id;
        const websiteUrl = process.env.REPLIT_DOMAINS || 'http://localhost:5000';
        bot.sendMessage(chatId, `ЁЯМР Mini Movies Website: ${websiteUrl}`);
    });

    // /addvideo ржХржорж╛ржирзНржб ржЖржкржбрзЗржЯ: ржПржЦржи File ID ржПржмржВ Size ржЪрж╛ржУржпрж╝рж╛ рж╣ржмрзЗ
    bot.onText(/\/addvideo/, (msg) => {
        const chatId = msg.chat.id;
        if (!isAdmin(chatId)) {
            bot.sendMessage(chatId, 'тЭМ ржПржЗ ржХржорж╛ржирзНржб рж╢рзБржзрзБ Admin рж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред');
            return;
        }
        
        bot.sendMessage(chatId, `ЁЯУ╣ ржирждрзБржи ржнрж┐ржбрж┐ржУ ржпрзЛржЧ ржХрж░рждрзЗ ржПржЗ ржлрж░ржорзНржпрж╛ржЯрзЗ ржкрж╛ржарж╛ржи:

Title: ржнрж┐ржбрж┐ржУ ржЯрж╛ржЗржЯрзЗрж▓
File ID: Telegram File ID (ржЖржкржирж╛рж░ ржмржЯржХрзЗ Channel-ржП ржЕрзНржпрж╛ржбржорж┐ржи ржХрж░рж╛рж░ ржкрж░ ржнрж┐ржбрж┐ржУ ржЖржкрж▓рзЛржб ржХрж░рж▓рзЗ ржкрж╛ржмрзЗржи)
Size: ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ ржмрж╛ржЗржЯрзЗ (рж╕рзНржЯрзНрж░рж┐ржорж┐ржВ ржПрж░ ржЬржирзНржп ржЬрж░рзБрж░рж┐, ржкрзНрж░рж╛рзЯ 50000000)
Thumb: Thumbnail URL (optional)
Desc: ржмрж┐ржмрж░ржг (optional)

ржЙржжрж╛рж╣рж░ржг:
Title: Amazing Private Movie
File ID: BAACAgIAAxkDAAI...
Size: 50000000
Desc: This is an amazing movie`);
    });

    // ржмржЯ Regex ржЖржкржбрзЗржЯ: File ID ржПржмржВ Size ржлрж┐рж▓рзНржб ржпрзЛржЧ ржХрж░рж╛ рж╣рж▓рзЛ
    bot.onText(/Title: (.+)\nFile ID: (.+)\nSize: (.+)(?:\nThumb: (.+))?(?:\nDesc: (.+))?/s, (msg, match) => {
        const chatId = msg.chat.id;
        if (!isAdmin(chatId)) return;
        
        const title = match[1];
        const telegram_file_id = match[2];
        const size = parseInt(match[3]) || 0; // Size ржХрзЗ integer рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржн ржХрж░рж╛
        const thumbnail = match[4] || null;
        const description = match[5] || '';
        
        const video = {
            id: Date.now(),
            title,
            telegram_file_id, // File ID рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржн
            size,
            thumbnail,
            description,
            views: 0,
            category: 'movie',
            addedAt: new Date().toISOString()
        };
        
        videos.push(video);
        bot.sendMessage(chatId, `тЬЕ ржнрж┐ржбрж┐ржУ рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ!\n\nЁЯОм Title: ${title}\nЁЯФЧ File ID: ${telegram_file_id}\nЁЯУР Size: ${size} bytes`);
    });

    // ... (existing /listvideo, /removevideo, /stats logic) ...
    bot.onText(/\/listvideo/, (msg) => {
        const chatId = msg.chat.id;
        if (!isAdmin(chatId)) {
            bot.sendMessage(chatId, 'тЭМ ржПржЗ ржХржорж╛ржирзНржб рж╢рзБржзрзБ Admin рж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред');
            return;
        }
        
        if (videos.length === 0) {
            bot.sendMessage(chatId, 'ЁЯУн ржХрзЛржи ржнрж┐ржбрж┐ржУ ржирзЗржЗред');
            return;
        }
        
        let videoList = 'ЁЯУ╣ рж╕ржм ржнрж┐ржбрж┐ржУ:\n\n';
        videos.forEach((video, index) => {
            videoList += `${index + 1}. ${video.title}\n   ID: ${video.id}\n   Views: ${video.views}\n\n`;
        });
        
        bot.sendMessage(chatId, videoList);
    });

    bot.onText(/\/removevideo (.+)/, (msg, match) => {
        const chatId = msg.chat.id;
        if (!isAdmin(chatId)) {
            bot.sendMessage(chatId, 'тЭМ ржПржЗ ржХржорж╛ржирзНржб рж╢рзБржзрзБ Admin рж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред');
            return;
        }
        
        const videoId = parseInt(match[1]);
        const videoIndex = videos.findIndex(v => v.id === videoId);
        
        if (videoIndex === -1) {
            bot.sendMessage(chatId, 'тЭМ ржнрж┐ржбрж┐ржУ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред');
            return;
        }
        
        const removedVideo = videos.splice(videoIndex, 1)[0];
        bot.sendMessage(chatId, `тЬЕ ржнрж┐ржбрж┐ржУ ржорзБржЫрзЗ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝рзЗржЫрзЗ: ${removedVideo.title}`);
    });

    bot.onText(/\/stats/, (msg) => {
        const chatId = msg.chat.id;
        if (!isAdmin(chatId)) {
            bot.sendMessage(chatId, 'тЭМ ржПржЗ ржХржорж╛ржирзНржб рж╢рзБржзрзБ Admin рж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред');
            return;
        }
        
        const totalVideos = videos.length;
        const totalViews = videos.reduce((sum, video) => sum + video.views, 0);
        const mostViewed = videos.length > 0 ? videos.reduce((max, video) => video.views > max.views ? video : max) : null;
        
        let statsMsg = `ЁЯУК Platform Statistics:\n\n`;
        statsMsg += `ЁЯУ╣ ржорзЛржЯ ржнрж┐ржбрж┐ржУ: ${totalVideos}\n`;
        statsMsg += `ЁЯСА ржорзЛржЯ Views: ${totalViews}\n`;
        if (mostViewed) {
            statsMsg += `ЁЯФе рж╕ржмржЪрзЗржпрж╝рзЗ ржЬржиржкрзНрж░рж┐ржпрж╝: ${mostViewed.title} (${mostViewed.views} views)`;
        }
        
        bot.sendMessage(chatId, statsMsg);
    });

    // Error handling for bot
    bot.on('error', (error) => {
        console.log('Telegram Bot Error:', error.code, error.message);
    });
}

// Start server
app.listen(PORT, '0.0.0.0', () => {
    console.log(`ЁЯЪА Mini Movies Platform running on port ${PORT}`);
    if (process.env.TELEGRAM_BOT_TOKEN) {
        console.log('ЁЯдЦ Telegram Bot is active');
    } else {
        console.log('тЪая╕П Telegram Bot token not found. Add TELEGRAM_BOT_TOKEN to environment variables.');
    }
});
